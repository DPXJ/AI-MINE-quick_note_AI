# 🔧 快捷键过一会儿失效问题 - 修复说明

## ❗ 问题描述

**症状**：
- ✅ 程序启动后，快捷键正常工作
- ❌ 1-2 分钟后，快捷键突然失效
- ✅ 程序本身还在运行（托盘图标还在）
- ✅ 通过托盘菜单功能仍然正常

## 🔍 根本原因

**pynput 监听线程意外退出，但主程序没有发现**

可能导致监听线程退出的原因：
1. **未捕获的异常** - 按键处理中的异常导致线程崩溃
2. **系统权限变化** - Windows UAC 或安全策略导致监听失败
3. **资源冲突** - 与其他全局钩子程序冲突
4. **线程被垃圾回收** - Python GC 错误地回收了线程对象
5. **Windows 消息队列满** - 大量按键事件导致队列溢出

---

## ✅ 修复方案

### 1. 添加看门狗机制（Watchdog）

**核心思路**：创建一个独立的监控线程，定期检查监听器是否存活，如果发现死掉就自动重启。

```python
def _watchdog(self):
    """看门狗线程：监控监听器是否存活"""
    while not self.stop_watchdog:
        time.sleep(10)  # 每10秒检查一次
        
        # 检查监听器是否还在运行
        if self.listener and not self.listener.is_alive():
            logger.warning("检测到快捷键监听器已停止，正在重启...")
            self._start_listener()  # 自动重启
```

**效果**：即使监听线程意外退出，最多 10 秒后就会自动恢复。

### 2. 改进异常处理

**问题**：pynput 的回调函数如果抛出异常，可能导致整个监听线程崩溃。

**解决**：
```python
def _on_press(self, key):
    try:
        # ... 处理逻辑 ...
    except Exception as e:
        logger.error(f"按键处理异常: {e}", exc_info=True)
    
    return True  # ← 始终返回 True，确保监听继续
```

### 3. 回调函数在独立线程执行

**问题**：如果回调函数执行时间过长或卡死，会阻塞监听线程。

**解决**：
```python
def _check_hotkeys(self):
    if current_combo in self.hotkeys:
        callback = self.hotkeys[current_combo]
        # 在新线程中执行，避免阻塞监听线程
        threading.Thread(target=callback, daemon=True).start()
```

### 4. 显式设置 suppress=False

```python
self.listener = keyboard.Listener(
    on_press=self._on_press,
    on_release=self._on_release,
    suppress=False  # ← 确保异常不会终止监听
)
```

### 5. 添加状态监控方法

```python
def is_alive(self) -> bool:
    """检查监听器是否存活"""
    return (
        self.is_running and 
        self.listener is not None and 
        self.listener.is_alive()
    )

def get_status(self) -> dict:
    """获取详细状态信息"""
    return {
        'is_running': self.is_running,
        'listener_exists': self.listener is not None,
        'listener_alive': self.listener.is_alive(),
        'watchdog_running': self.watchdog_thread.is_alive(),
        'registered_hotkeys': list(self.hotkeys.keys())
    }
```

---

## 📋 修改的文件

### `src/core/hotkey.py` - 快捷键监听模块

#### 新增字段
```python
self.is_running = False          # 运行标志
self.watchdog_thread = None      # 看门狗线程
self.stop_watchdog = False       # 停止看门狗标志
```

#### 新增方法
- ✅ `_start_listener()` - 内部启动监听器
- ✅ `_watchdog()` - 看门狗线程
- ✅ `_safe_callback()` - 安全执行回调
- ✅ `is_alive()` - 检查存活状态
- ✅ `get_status()` - 获取详细状态

#### 改进方法
- ✅ `start()` - 启动看门狗
- ✅ `stop()` - 停止看门狗
- ✅ `_on_press()` - 始终返回 True
- ✅ `_on_release()` - 始终返回 True
- ✅ `_check_hotkeys()` - 在新线程执行回调

---

## 🚀 工作流程

### 正常流程
```
程序启动
  ↓
启动快捷键监听器
  ↓
启动看门狗线程（每10秒检查一次）
  ↓
监听器持续运行
  ↓
用户按下快捷键 → 触发回调
```

### 异常恢复流程
```
监听线程意外退出
  ↓
看门狗检测到（最多10秒延迟）
  ↓
自动重启监听器
  ↓
恢复正常运行
  ↓
用户无感知（可能丢失 10 秒内的按键）
```

---

## 🔧 日志监控

### 正常日志
```
[INFO] 快捷键监听器已初始化
[INFO] 快捷键监听器已启动
[INFO] 快捷键看门狗已启动
[INFO] 触发快捷键: control+shift+space
```

### 异常恢复日志
```
[WARNING] 检测到快捷键监听器已停止，正在重启...
[INFO] 快捷键监听器已启动
[INFO] 快捷键监听器已重启
```

### 严重错误日志
```
[ERROR] 按键处理异常: ...
[ERROR] 快捷键回调执行失败: ...
[ERROR] 看门狗检查异常: ...
```

---

## 🎯 验证修复

### 测试步骤

1. **启动程序**
```bash
# 以管理员身份运行
右键 QuickNote_AI.exe → 以管理员身份运行
```

2. **初始测试（0-1 分钟）**
- [ ] 按 `Ctrl+Shift+Space`，是否弹出窗口？
- [ ] 多次测试，是否稳定？

3. **延迟测试（1-3 分钟）**
- [ ] 等待 1 分钟后，再按快捷键
- [ ] 等待 2 分钟后，再按快捷键
- [ ] 等待 5 分钟后，再按快捷键

4. **长时间测试（10+ 分钟）**
- [ ] 程序运行 10 分钟后测试
- [ ] 期间切换不同应用
- [ ] 快捷键是否持续有效？

5. **查看日志**
```bash
# 打开 logs 目录，查看最新日志
notepad logs\quicknote_*.log
```

搜索关键字：
- `"监听器已停止"` - 是否有自动重启？
- `"已重启"` - 重启是否成功？
- `"异常"` - 是否有错误？

---

## 💡 额外优化建议

### 如果问题仍然存在

#### 方案 A：缩短看门狗检查间隔
```python
time.sleep(5)  # 改为 5 秒检查一次
```

#### 方案 B：添加心跳机制
在主程序中定期调用：
```python
if not self.hotkey_listener.is_alive():
    logger.warning("检测到快捷键监听器死掉")
    self.hotkey_listener.start()
```

#### 方案 C：使用 Windows 原生 API
如果 pynput 仍不稳定，可以考虑：
- `keyboard` 库（更底层）
- `pyHook3`（Windows 专用）
- 或直接使用 `ctypes` 调用 Windows API

---

## 📊 性能影响

**看门狗线程的开销**：
- CPU：几乎为 0（每 10 秒运行一次，每次 < 1ms）
- 内存：< 100 KB（单个线程）
- 影响：可忽略不计

**自动重启的影响**：
- 重启耗时：< 100ms
- 用户体验：可能丢失重启期间（最多 100ms）的按键
- 频率：正常情况下不应该重启；如果频繁重启说明有更深层问题

---

## 🐛 如果还是失效

### 收集诊断信息

1. **查看日志**
```bash
logs\quicknote_*.log
```

2. **手动检查状态**
打开 Python 控制台，在程序运行时：
```python
status = app.hotkey_listener.get_status()
print(status)
```

3. **检查进程**
```bash
# PowerShell
Get-Process | Where-Object {$_.Name -like "*QuickNote*"}
```

4. **检查是否有冲突程序**
可能冲突的程序：
- 其他快捷键工具（AutoHotkey、Ditto 等）
- 游戏反外挂（可能阻止全局钩子）
- 安全软件（可能限制键盘钩子）

---

## 🎉 预期效果

修复后：
- ✅ 快捷键持续稳定工作
- ✅ 即使偶尔失效，10 秒内自动恢复
- ✅ 日志中可见自动恢复记录
- ✅ 用户几乎无感知

---

**现在重新打包测试吧！** 🚀

如果运行 10 分钟后快捷键仍然有效，说明修复成功！

