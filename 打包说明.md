# QuickNote AI - EXE打包说明

## 📦 打包步骤

### 方法一：使用批处理脚本（推荐）

1. **确保已安装所有依赖**
```bash
pip install -r requirements.txt
```

2. **直接运行打包脚本**
```bash
build.bat
```

3. **等待打包完成**
   - 打包过程需要 2-5 分钟
   - 打包成功后，可执行文件位于 `dist\QuickNote_AI\QuickNote_AI.exe`

### 方法二：手动使用 PyInstaller

1. **安装 PyInstaller**
```bash
pip install pyinstaller
```

2. **执行打包命令**
```bash
pyinstaller build.spec
```

3. **打包完成**
   - 可执行文件：`dist\QuickNote_AI\QuickNote_AI.exe`
   - 依赖文件：`dist\QuickNote_AI\` 目录下的所有文件

## 📂 打包后的文件结构

```
dist/
└── QuickNote_AI/
    ├── QuickNote_AI.exe    # 主程序
    ├── config.yaml         # 自动复制的配置文件
    ├── _internal/          # Python运行时和依赖库
    └── logs/               # 日志目录（首次运行时创建）
```

## ⚙️ 部署和使用

### 1. 准备配置文件

在运行打包好的 EXE 之前，需要在 `QuickNote_AI.exe` 同目录下创建 `.env` 文件：

```env
# AI 提供商配置 (openai 或 anthropic)
AI_PROVIDER=openai

# OpenAI 配置
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4o-mini
OPENAI_BASE_URL=https://api.openai.com/v1

# 或者使用 Claude (Anthropic)
# ANTHROPIC_API_KEY=your_anthropic_api_key_here
# ANTHROPIC_MODEL=claude-3-5-sonnet-20241022

# Notion 配置
NOTION_API_KEY=your_notion_api_key_here
NOTION_DATABASE_ID=your_notion_database_id_here

# Flomo 配置（可选）
FLOMO_API_URL=https://flomoapp.com/iwh/your_webhook_url_here
```

### 2. 检查配置文件

确保 `config.yaml` 文件在 EXE 同目录下（打包时会自动复制）。

### 3. 首次运行

1. 双击 `QuickNote_AI.exe` 启动程序
2. 程序会最小化到系统托盘（任务栏右下角）
3. 右键托盘图标 → 设置，可以打开设置界面
4. 在设置界面中配置 API 密钥等信息

### 4. 快捷键使用

- **Ctrl+Shift+Space**：快速输入窗口
- **Ctrl+Shift+C**：开关剪切板监控

## 🔧 常见问题

### 1. 打包失败：找不到模块

**解决方法**：
```bash
# 重新安装依赖
pip install -r requirements.txt --force-reinstall

# 清理缓存后重新打包
rmdir /s /q build dist
build.bat
```

### 2. EXE 运行时缺少 DLL

**解决方法**：
- 安装 [Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)
- 或者修改 `build.spec`，在打包时包含更多库

### 3. 杀毒软件误报

**原因**：PyInstaller 打包的程序有时会被杀毒软件误报

**解决方法**：
- 在杀毒软件中添加白名单
- 使用数字签名（需要购买代码签名证书）

### 4. 打包体积过大

**优化方法**：

编辑 `build.spec`，排除不需要的模块：

```python
excludes = [
    'matplotlib',
    'numpy',
    'pandas',
    'scipy',
    'IPython',
    'jupyter',
    # 其他不需要的库
]
```

然后重新打包：
```bash
pyinstaller build.spec
```

### 5. 程序无法启动或闪退

**调试方法**：

修改 `build.spec` 中的 `console` 参数：

```python
exe = EXE(
    ...
    console=True,  # 改为 True，显示控制台窗口查看错误
    ...
)
```

重新打包后运行，可以看到错误信息。

## 📦 单文件打包（可选）

如果想要打包成单个 EXE 文件（更便于分发，但启动稍慢）：

修改 `build.spec`：

```python
exe = EXE(
    pyz,
    a.scripts,
    a.binaries,        # 添加这行
    a.zipfiles,        # 添加这行
    a.datas,           # 添加这行
    [],
    name='QuickNote_AI',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
)

# 注释掉 COLLECT 部分
# coll = COLLECT(...)
```

然后重新打包：
```bash
pyinstaller build.spec
```

打包后的单文件位于：`dist\QuickNote_AI.exe`

## 🚀 分发打包后的程序

### 1. 完整分发包（推荐）

创建一个完整的分发包，包含：

```
QuickNote_AI_v1.0/
├── QuickNote_AI.exe
├── config.yaml
├── .env.example          # 配置模板
├── 使用说明.md
└── _internal/            # 所有依赖文件
```

### 2. 压缩分发

```bash
# 将整个 dist\QuickNote_AI 文件夹打包成 ZIP
# 用户解压后即可使用
```

### 3. 制作安装程序（高级）

可以使用 [Inno Setup](https://jrsoftware.org/isinfo.php) 或 [NSIS](https://nsis.sourceforge.io/) 制作专业的安装程序。

## 📝 注意事项

1. **配置文件**：首次分发时不要包含真实的 API 密钥，使用 `.env.example` 作为模板
2. **日志目录**：程序会在首次运行时自动创建 `logs/` 目录
3. **系统托盘**：程序启动后会最小化到系统托盘，不会显示主窗口
4. **管理员权限**：全局快捷键监听可能需要管理员权限（视系统安全设置而定）
5. **防火墙**：程序需要网络访问权限来调用 API

## 🔄 更新打包配置

如果项目结构或依赖发生变化，需要更新 `build.spec`：

1. **添加新的数据文件**：
```python
datas = [
    ('config.yaml', '.'),
    ('icons/', 'icons/'),  # 示例：添加图标目录
]
```

2. **添加新的隐藏导入**：
```python
hiddenimports = [
    # 原有的导入
    'new_module',  # 添加新模块
]
```

3. **设置程序图标**：
```python
exe = EXE(
    ...
    icon='icon.ico',  # 指定图标文件路径
)
```

## 💡 性能优化建议

1. **使用 UPX 压缩**（已启用）：减小可执行文件体积
2. **排除不需要的模块**：在 `excludes` 中列出
3. **单文件 vs 多文件**：
   - 单文件：便于分发，启动稍慢（需要解压到临时目录）
   - 多文件：启动快，但文件多（推荐）

## 📧 技术支持

如果在打包过程中遇到问题，请检查：

1. Python 版本（建议 3.8-3.11）
2. PyInstaller 版本（建议 >= 6.3.0）
3. 所有依赖是否正确安装
4. 系统环境变量配置

打包成功后，欢迎分享你的使用体验！

