# 冥想功能修复说明

## 🐛 已修复的问题

### 1. 切换标签时第二行显示异常
**问题描述**：多次切换标签后，选项区域（状态、优先级、标签等）字体压在一起

**修复方案**：
- 在每个标签的切换逻辑中，显式设置所有标签按钮的状态
- 显式控制所有选项区域（notion_options、flomo_options、ticktick_options、meditation_options）的显示/隐藏
- 确保冥想计时器的显示/隐藏状态正确

### 2. 其他标签显示冥想计时器
**问题描述**：在notion/flomo/滴答清单标签页面时，不应该显示冥想计时器

**修复方案**：
- 在切换到notion/flomo/ticktick标签时，强制隐藏冥想计时器
- 强制显示输入框
- 确保只有在冥想标签页才显示冥想相关内容

### 3. 计时器数据丢失和界面串乱
**问题描述**：
- 切换标签时计时器停止
- 切换回冥想标签时数据丢失
- 界面显示错乱

**修复方案**：
- **计时器独立运行**：`meditation_timer` 独立运行，不受标签切换影响
- **数据持久化**：切换标签时不清空 `meditation_current_seconds` 和 `meditation_is_running`
- **智能显示**：切换回冥想标签时，根据计时器状态决定显示内容：
  - 如果正在计时或已暂停 → 显示计时器
  - 如果未开始 → 显示选项

## ✨ 优化后的逻辑

### 切换标签逻辑

```
切换到 Notion/Flomo/滴答清单:
├─ 隐藏冥想计时器 ✓
├─ 显示输入框 ✓
├─ 显示对应的选项区域 ✓
└─ 计时器继续在后台运行 ✓

切换到冥想:
├─ 判断计时器状态
│  ├─ 正在运行或已暂停
│  │  ├─ 隐藏输入框
│  │  ├─ 隐藏选项区域
│  │  └─ 显示计时器 ✓
│  └─ 未开始
│     ├─ 显示输入框
│     ├─ 显示选项区域
│     └─ 隐藏计时器 ✓
└─ 计时器数据保持不变 ✓
```

### 计时器独立运行

```
开始计时:
├─ 启动 QTimer（每秒触发一次）
├─ 设置 meditation_is_running = True
└─ 更新时间显示

切换标签:
├─ QTimer 继续运行 ✓
├─ meditation_current_seconds 继续更新 ✓
└─ 时间显示继续更新 ✓

手动停止:
├─ 停止 QTimer
├─ 清空 meditation_current_seconds
├─ 设置 meditation_is_running = False
└─ 恢复界面（仅在冥想标签页）
```

## 📝 关键代码修改

### 1. `_switch_platform` 方法

```python
# Notion/Flomo/TickTick 标签
- 添加: self.meditation_timer_widget.setVisible(False)
- 添加: self.text_edit.setVisible(True)
- 确保隐藏冥想计时器

# 冥想标签
- 判断计时器状态
- 根据状态决定显示内容
```

### 2. `_start_meditation_timer` 方法

```python
# 计时器启动
- QTimer.start(1000) - 独立运行
- 只在冥想标签页时显示计时器UI
```

### 3. `_update_meditation_time` 方法

```python
# 时间更新
- 不受标签切换影响
- 始终更新 meditation_current_seconds
- 始终更新时间显示
```

### 4. `_stop_meditation` 方法

```python
# 手动停止
- 停止 QTimer
- 清空数据
- 只在冥想标签页时恢复UI
```

### 5. `hide` 方法

```python
# 隐藏窗口
- 移除遮罩
- 不停止冥想计时器（后台继续运行）
```

## 🎯 测试场景

### 场景1：正常计时
1. ✅ 切换到冥想标签
2. ✅ 选择倒计时45分钟
3. ✅ 计时器开始运行
4. ✅ 切换到Notion标签
5. ✅ 输入框正常显示，无冥想计时器
6. ✅ 切换回冥想标签
7. ✅ 计时器继续显示，时间正确

### 场景2：暂停后切换
1. ✅ 开始倒计时
2. ✅ 点击暂停
3. ✅ 切换到Flomo标签
4. ✅ 输入框正常显示
5. ✅ 切换回冥想标签
6. ✅ 计时器显示暂停状态，时间保持

### 场景3：多次切换
1. ✅ Notion → Flomo → TickTick → 冥想
2. ✅ 每次切换，第二行选项区域显示正常
3. ✅ 不会出现字体压在一起的情况

### 场景4：手动停止
1. ✅ 开始倒计时
2. ✅ 点击停止按钮
3. ✅ 返回冥想选项界面
4. ✅ 可以重新开始新的计时

### 场景5：倒计时结束
1. ✅ 开始倒计时（可选10分钟测试）
2. ✅ 切换到其他标签继续工作
3. ✅ 倒计时在后台继续
4. ✅ 倒计时结束后自动停止
5. ✅ 切换回冥想标签，显示已结束状态

## 📊 修改的文件

- `src/gui/quick_input.py`
  - `_switch_platform()` - 优化标签切换逻辑
  - `_start_meditation_timer()` - 计时器独立运行
  - `_update_meditation_time()` - 独立更新时间
  - `_stop_meditation()` - 手动停止逻辑
  - `hide()` - 添加注释说明

## ✅ 修复完成

所有问题已修复，可以正常使用：
- ✅ 标签切换时界面正常
- ✅ 其他标签不显示冥想计时器
- ✅ 计时器独立运行，数据不丢失
- ✅ 切换回冥想标签时正确显示
- ✅ 手动停止后正常恢复界面
