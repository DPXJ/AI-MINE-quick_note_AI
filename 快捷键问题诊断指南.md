# QuickNote AI 快捷键问题诊断指南

## 问题现象
1. Ctrl+Enter 无法换行
2. 快捷键（Ctrl+Shift+Space）不响应

## 解决方案

### 一、换行功能修复

**已修复内容**：
- 改进了 Ctrl+Enter 的检测逻辑
- 直接插入换行符，不依赖系统默认行为
- 兼容不同系统的 Ctrl 键修饰符

**测试方法**：
1. 打开快速输入窗口
2. 输入一些文字
3. 按 `Ctrl+Enter`，应该会换行
4. 按 `Enter`，应该会提交

**如果还是不行**：
- 检查是否按对了键（是 Ctrl+Enter，不是 Shift+Enter）
- 查看窗口底部的提示："💡 Ctrl+Enter换行 | Enter发送 | Esc取消"

---

### 二、快捷键问题诊断

#### 步骤1：使用诊断工具

运行诊断工具：
```bash
诊断快捷键.bat
```

#### 步骤2：观察日志

应用启动后，按下快捷键 `Ctrl+Shift+Space`，观察日志输出。

**正常情况应该看到**：
```
按键按下: ctrl_l, 当前集合: {'ctrl_l'}
按键按下: shift_l, 当前集合: {'ctrl_l', 'shift_l'}
按键按下: space, 当前集合: {'ctrl_l', 'shift_l', 'space'}
按键组合: control+shift+space, 已注册: ['control+shift+space']
✓ 触发快捷键: control+shift+space
显示快速输入窗口
```

**如果看到不同的输出**：

##### 情况A：按键没有被检测到
```
# 没有任何输出
```
**原因**：监听器未启动或已死亡
**解决**：
1. 通过系统托盘菜单选择"重启快捷键"
2. 如果还是不行，重启应用

##### 情况B：按键被检测到，但组合不匹配
```
按键按下: ctrl_l, 当前集合: {'ctrl_l'}
按键按下: shift, 当前集合: {'ctrl_l', 'shift'}  
按键按下: space, 当前集合: {'ctrl_l', 'shift', 'space'}
按键组合: control+shift+space, 已注册: ['control+shift+space']
✗ 未匹配的组合: control+shift+space  # ← 这里不匹配
```
**原因**：快捷键格式化问题
**解决**：检查 config.yaml 中的快捷键配置

##### 情况C：按键顺序问题
```
按键按下: space, 当前集合: {'space'}  # ← 先按了 space
按键按下: ctrl_l, 当前集合: {'space', 'ctrl_l'}
```
**原因**：按键顺序不对
**解决**：先按修饰键（Ctrl+Shift），最后按 Space

#### 步骤3：检查配置文件

打开 `config.yaml`，查看快捷键配置：

```yaml
hotkeys:
  quick_input: "ctrl+shift+space"  # 应该是这个格式
  toggle_clipboard: "ctrl+shift+c"
```

**正确格式**：
- 小写字母
- 用 `+` 连接
- 修饰键在前：`ctrl+shift+space`（正确）
- ❌ 错误格式：`Ctrl+Shift+Space`、`ctrl shift space`

#### 步骤4：检查权限

**Windows系统**：
- 确保应用以管理员身份运行（某些情况下需要）
- 右键 `run.bat` → "以管理员身份运行"

**其他可能的冲突**：
- 其他软件占用了快捷键
- 系统快捷键冲突
- 安全软件拦截

---

### 三、临时解决方案

#### 方案1：更换快捷键

如果 `Ctrl+Shift+Space` 被占用，可以更换为其他组合：

1. 打开 `config.yaml`
2. 修改快捷键：
```yaml
hotkeys:
  quick_input: "ctrl+alt+space"  # 改为 Ctrl+Alt+Space
```
3. 重启应用

#### 方案2：使用系统托盘菜单

不使用快捷键，直接通过系统托盘图标：
1. 找到任务栏右下角的 QuickNote 图标
2. 右键点击
3. 选择"快速输入"

#### 方案3：重启快捷键监听器

通过系统托盘菜单：
1. 右键托盘图标
2. 选择"重启快捷键"
3. 等待提示"快捷键已重启"

---

### 四、性能优化后的变化

**改进内容**：
- 检查频率：10秒 → 15秒（平衡性能和稳定性）
- 移除过于激进的失效检测
- 保留必要的线程监控和长时间无活动检测（2小时）

**优点**：
- 减少 CPU 占用
- 减少误判重启
- 提升长期稳定性

**缺点**：
- 如果监听器真的死掉了，可能需要等待15秒才能自动恢复
- 建议出现问题时手动重启（更快）

---

### 五、常见问题 FAQ

#### Q1：换行功能正常，但快捷键不响应？
A：这是两个独立的问题。换行是窗口内的功能，快捷键是全局监听。请按照"步骤2"诊断快捷键。

#### Q2：日志中看到"按键被检测到"，但窗口没弹出？
A：可能是回调函数执行失败。查看日志中是否有错误信息。

#### Q3：有时候快捷键有效，有时候无效？
A：
1. 检查是否在特定应用中无效（如某些全屏游戏）
2. 检查是否有其他软件占用快捷键
3. 尝试通过托盘菜单"重启快捷键"

#### Q4：修复后还是不行怎么办？
A：
1. 完全重启应用（不是重启快捷键）
2. 以管理员身份运行
3. 更换快捷键组合
4. 查看日志文件 `logs/quicknote_*.log`

---

### 六、调试日志位置

日志文件位于项目根目录下的 `logs` 文件夹：
```
logs/
  quicknote_2025-XX-XX.log  # 最新日志
```

**查看日志**：
- 用文本编辑器打开
- 搜索关键词：
  - "按键按下"：查看按键检测
  - "按键组合"：查看组合匹配
  - "触发快捷键"：查看是否触发成功
  - "ERROR"：查看错误信息

---

### 七、获取帮助

如果以上方法都无法解决，请：

1. **收集信息**：
   - 日志文件（`logs/quicknote_*.log`）
   - 系统信息（Windows版本）
   - 问题描述（什么时候出现的）

2. **检查配置**：
   - `config.yaml` 内容
   - 是否修改过代码

3. **联系开发者**

---

## 总结

**换行功能**：已修复，应该可以正常使用
**快捷键功能**：需要诊断，请按照上述步骤操作

**建议顺序**：
1. 先测试换行功能是否正常
2. 再运行诊断工具检查快捷键
3. 查看日志定位问题
4. 尝试临时解决方案
5. 如果无法解决，提供日志和详细信息
